<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="light dark">
    <title>Shhhh‚Ä¶ It‚Äôs a Secret | RSVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #f7f1e9;
            --card: #ffffff;
            --accent: #222222;
            --accent-light: #c4b59c;
            --font-serif: "Playfair Display", "Times New Roman", serif;
            --font-sans: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            background: linear-gradient(135deg, #e4d7c5, #f7f1e9);
            color: #111;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .page {
            width: 100%;
            max-width: 720px;
            padding: 24px 16px 40px;
        }

        .card {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.08);
            padding: 28px 22px 30px;
        }

        @media (min-width: 640px) {
            .card {
                padding: 40px 40px 42px;
            }
        }

        .tagline {
            text-transform: uppercase;
            letter-spacing: 0.24em;
            font-size: 11px;
            color: #777;
            text-align: center;
        }

        .hero-title {
            font-family: var(--font-serif);
            font-size: 26px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin: 8px 0 4px;
            text-align: center;
            line-height: 1.4;
        }

        .hero-script {
            font-family: "Great Vibes", "Brush Script MT", cursive;
            font-size: 22px;
            margin: 0 0 12px;
            text-align: center;
        }

        .hero-sub {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
        }

        .divider {
            border: none;
            border-top: 1px solid var(--accent-light);
            margin: 18px 0 22px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            max-width: 640px;
            margin: 0 auto 16px;
            justify-items: flex-start;
        }

        @media (min-width: 540px) {
            .details-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .details-block {
            text-align: left;
        }

        .details-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.20em;
            color: #777;
            margin-bottom: 6px;
        }

        .details-value {
            font-family: var(--font-serif);
            font-size: 14px;
            line-height: 1.5;
        }

        .details-block-dress .details-value {
            font-family: var(--font-sans);
            font-size: 14px;
            line-height: 1.5;
        }

        .dress-main-line {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .dress-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .dress-list li {
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.4;
        }

        .dress-list strong {
            font-weight: 600;
        }

        .invitee-box {
            margin: 16px 0 24px;
            padding: 12px 14px;
            border-radius: 12px;
            background: #faf5ee;
            border: 1px dashed #d2c3ac;
            font-size: 13px;
            line-height: 1.5;
        }

        .invitee-label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 10px;
            color: #777;
            margin-bottom: 3px;
        }

        .invitee-names {
            font-family: var(--font-serif);
            font-size: 16px;
        }

        .rsvp-title {
            font-family: var(--font-serif);
            font-size: 25px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin: 22px 0 4px;
        }

        .helper {
            font-size: 11px;
            color: #777;
            margin-top: 4px;
        }

        .rsvp-helper {
            margin-top: 2px;
            margin-bottom: 12px;
        }

        .rsvp-deadline-date {
            font-family: var(--font-serif);
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #444;
            font-size: 12px;
        }

        form {
            display: grid;
            gap: 14px;
        }

        label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 10px 11px;
            border-radius: 10px;
            border: 1px solid #d6c8b4;
            font: inherit;
            font-size: 14px;
            background: #fdfbf7;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
        }

        .button-row {
            margin-top: 10px;
        }

        button[type="submit"],
        .btn-secondary {
            display: inline-block;
            padding: 11px 20px;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 12px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
            white-space: nowrap;
        }

        button[type="submit"]:hover,
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.18);
            background: #000;
        }

        button[type="submit"]:active,
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-secondary {
            background: #8b7b64;
            margin-left: 8px;
        }

        .footer-note {
            margin-top: 20px;
            font-size: 13px;
            color: #7a6b57;
            text-align: center;
        }

        .error {
            color: #b30000;
            font-size: 12px;
            margin-top: 6px;
        }

        .hidden {
            display: none;
        }

        .guest-list {
            margin-top: 8px;
            display: grid;
            gap: 10px;
        }

        .guest-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 9px 10px;
            border-radius: 10px;
            background: #fdf7ef;
            border: 1px solid #e0d1bc;
        }

        @media (min-width: 520px) {
            .guest-row {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .guest-name {
            font-family: var(--font-serif);
            font-size: 15px;
        }

        .guest-radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 13px;
        }

        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .search-row input[type="text"] {
            flex: 1 1 180px;
        }

        /* multiple-match selector */
        .match-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 13px;
        }

        .match-option-text {
            font-family: var(--font-serif);
        }

        /* --- Dark mode: follow device setting --- */
        @media (prefers-color-scheme: dark) {

            body {
                background: radial-gradient(circle at top, #3a342b 0, #141210 55%, #040302 100%);
                color: #f7f1e9;
            }

            .card {
                background: #191613;
                box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
            }

            .divider {
                border-top-color: #4a443a;
            }

            .tagline,
            .details-label,
            label,
            .helper,
            .rsvp-helper {
                color: #c7bfb1;
            }

            .hero-title,
            .hero-script,
            .hero-sub,
            .details-value,
            .guest-name,
            .footer-note,
            .rsvp-title {
                color: #f7f1e9;
            }

            .rsvp-deadline-date {
                color: #f7f1e9;
            }

            input[type="text"],
            input[type="email"],
            textarea {
                background: #151310;
                border-color: #4a443a;
                color: #f7f1e9;
            }

            input::placeholder,
            textarea::placeholder {
                color: #a39a8a;
            }

            .invitee-box,
            .guest-row {
                background: #201d19;
                border-color: #4a443a;
            }

            .error {
                color: #ffb3b3;
            }

            button[type="submit"] {
                background: #f0e4cf;
                color: #111;
            }

            button[type="submit"]:hover {
                background: #fff1d8;
            }

            .btn-secondary {
                background: #c4b59c;
                color: #111;
            }

            .btn-secondary:hover {
                background: #ddccb2;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="card">
            <!-- HERO / INTRO -->
            <div class="tagline">Shhhh... it's a secret üíç</div>
            <h1 class="hero-title">
                The One Where<br>
                Esha Becomes a Fianc√©e
            </h1>
            <p class="hero-script">
                A surprise proposal party for Esha
            </p>
            <p class="hero-sub">
                Your presence means the world to us.<br>
                Come celebrate us and the beginning of our forever!
            </p>

            <!-- LOCAL VIDEO -->
            <div style="
          max-width: 480px;
          margin: 1.6em auto 0.9em;
          box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16);
          border-radius: 8px;
          overflow: hidden;
        ">
                <video id="inviteVideo" src="Invited.mp4" type="video/mp4" autoplay playsinline controls
                    preload="metadata" style="width: 100%; display: block;">
                    Your browser does not support the video tag.
                </video>
            </div>

            <hr class="divider">

            <!-- EVENT DETAILS: Date/Time, Dress Code, Location -->
            <div class="details-grid">
                <div class="details-block">
                    <div class="details-label">Date &amp; Time</div>
                    <div class="details-value">
                        Saturday, February 21, 2026<br>
                        6:00 PM ‚Äì 10:30 PM
                    </div>
                </div>

                <div class="details-block details-block-dress">
                    <div class="details-label">Dress Code</div>
                    <div class="details-value">
                        <div class="dress-main-line">Cocktail attire</div>
                        <ul class="dress-list">
                            <li><strong>Men:</strong> Formal wear</li>
                            <li><strong>Ladies:</strong> Cocktail dress (no sneakers)</li>
                            <li><strong>Note:</strong> Kindly refrain from wearing white</li>
                        </ul>
                    </div>
                </div>

                <div class="details-block">
                    <div class="details-label">Location</div>
                    <div class="details-value">
                        <strong>Highwater Rooftop</strong><br>
                        120 Water St<br>
                        New York, NY<br>
                        10005
                    </div>
                </div>
            </div>

            <!-- RSVP HEADER / DEADLINE -->
            <h2 class="rsvp-title">Kindly RSVP</h2>
            <div class="helper rsvp-helper">
                Please RSVP by
                <span class="rsvp-deadline-date">December 25, 2025.</span>
            </div>
            <div id="rsvpClosedMessage" class="error hidden" style="margin-top:8px;"></div>

            <!-- SINGLE FORM -->
            <form id="rsvpForm" method="POST" action="#">
                <!-- NAME SEARCH -->
                <div>
                    <label for="searchName">Search your name</label>
                    <div class="search-row">
                        <input id="searchName" type="text" placeholder="e.g. Vraj Patel" autocomplete="off">
                        <button type="button" class="btn-secondary" id="searchButton">Search</button>
                    </div>
                    <div class="helper">
                        Enter your first and last name as it appears on your invitation.
                        Everyone in your group will appear together.
                    </div>
                    <div id="searchError" class="error hidden"></div>
                </div>

                <!-- MULTIPLE MATCHES BOX -->
                <div id="multipleMatches" class="invitee-box hidden"></div>

                <!-- INVITEE BOX -->
                <div id="inviteeSection" class="invitee-box hidden">
                    <div class="invitee-label">This invitation is for</div>
                    <div id="inviteeNames" class="invitee-names">Guest(s)</div>
                    <div class="helper">
                        This RSVP is only for the person(s) named above.
                        Please do not forward or add additional guests.
                    </div>
                </div>

                <!-- Hidden fields for backend -->
                <input type="hidden" id="groupId" name="group_id">
                <input type="hidden" id="assignedGuests" name="assigned_guests">

                <!-- GUEST ATTENDANCE -->
                <div id="guestAttendanceSection" class="hidden">
                    <label>Who is coming?</label>
                    <div id="guestAttendanceList" class="guest-list"></div>
                    <div class="helper">
                        Please respond for each person listed above.
                    </div>
                </div>

                <!-- EMAIL + NOTES -->
                <div>
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" required placeholder="you@example.com">
                </div>

                <div>
                    <label for="notes">Notes (dietary needs, etc.)</label>
                    <textarea id="notes" name="notes"
                        placeholder="Let us know about any dietary restrictions or other details."></textarea>
                </div>

                <div class="button-row">
                    <button type="submit" id="submitButton" disabled>Submit RSVP</button>
                </div>

                <div id="errorMessage" class="error hidden"></div>
            </form>

            <div class="footer-note">
                Please keep this a surprise from Esha.<br>
                Thank you for helping make this night unforgettable.
            </div>
        </div>
    </div>

    <script src="guests.js"></script>
    <script>
        // RSVP closes after December 25, 2025 (inclusive)
        const RSVP_DEADLINE = new Date("2025-12-25T00:00:00"); // local time
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1Woihr76WByuveASdUiRObj6cve9hWJTlx5llP-sGbhHFeFHv9RbRzrr-t64f2FPX/exec";

        // Rate limiting for search
        const SEARCH_MAX_ATTEMPTS = 5;
        const SEARCH_COOLDOWN_MS = 60000; // 60 seconds
        let searchAttempts = 0;
        let lastSearchTime = 0;

        function normalize(str) {
            return (str || "").toLowerCase().trim();
        }

        // Return ALL matching groups so the guest can pick theirs
        function findGroupsByName(query) {
            const q = normalize(query);
            if (!q) return [];

            const qParts = q.split(/\s+/).filter(Boolean);
            const results = [];

            for (const [groupId, names] of Object.entries(guestGroups)) {
                let groupMatched = false;

                for (const name of names) {
                    const n = normalize(name);
                    const nParts = n.split(/\s+/).filter(Boolean);

                    let match = false;

                    if (qParts.length >= 2) {
                        // require exact full-name match
                        match = (n === q);
                    } else {
                        // single word: must match first or last word exactly
                        const first = nParts[0] || "";
                        const last = nParts[nParts.length - 1] || "";
                        match = (q === first || q === last);
                    }

                    if (match) {
                        groupMatched = true;
                        break;
                    }
                }

                if (groupMatched) {
                    results.push({ groupId, names });
                }
            }

            return results;
        }

        function slugifyName(name) {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "");
        }

        function buildGuestAttendanceRows(names) {
            const container = document.getElementById("guestAttendanceList");
            container.innerHTML = "";

            names.forEach((name, index) => {
                const slug = slugifyName(name) || ("guest_" + index);
                const row = document.createElement("div");
                row.className = "guest-row";

                row.innerHTML = `
          <div class="guest-name">${name}</div>
          <div class="guest-radio-group">
            <label>
              <input type="radio" name="attending_${slug}" value="Yes" required> Yes
            </label>
            <label>
              <input type="radio" name="attending_${slug}" value="No" required> No
            </label>
          </div>
        `;

                container.appendChild(row);
            });
        }

        function namesFromCsv(csv) {
            if (!csv) return [];
            return csv
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        function prefillFromSavedData(groupId, names) {
            fetch(`${SCRIPT_URL}?group_id=${encodeURIComponent(groupId)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.found) return;

                    const attendingList = namesFromCsv(data.attending);
                    const notAttendingList = namesFromCsv(data.not_attending);

                    if (data.email) {
                        document.getElementById("email").value = data.email;
                    }
                    if (data.notes) {
                        document.getElementById("notes").value = data.notes;
                    }

                    names.forEach((name, index) => {
                        const slug = slugifyName(name) || ("guest_" + index);
                        const yesSelector = `input[name="attending_${slug}"][value="Yes"]`;
                        const noSelector = `input[name="attending_${slug}"][value="No"]`;
                        const yesInput = document.querySelector(yesSelector);
                        const noInput = document.querySelector(noSelector);

                        if (!yesInput || !noInput) return;

                        if (attendingList.includes(name)) {
                            yesInput.checked = true;
                        } else if (notAttendingList.includes(name)) {
                            noInput.checked = true;
                        }
                    });
                })
                .catch(err => {
                    console.error("Error fetching saved RSVP:", err);
                });
        }

        // Apply a selected group to the UI + hidden fields
        function selectGroup(match) {
            const inviteeSection = document.getElementById("inviteeSection");
            const inviteeNames = document.getElementById("inviteeNames");
            const guestAttendanceSection = document.getElementById("guestAttendanceSection");
            const groupIdInput = document.getElementById("groupId");
            const assignedGuestsInput = document.getElementById("assignedGuests");
            const submitButton = document.getElementById("submitButton");
            const multipleMatchesBox = document.getElementById("multipleMatches");

            // hide the multiple-match chooser once selected
            multipleMatchesBox.classList.add("hidden");
            multipleMatchesBox.innerHTML = "";

            const namesText = match.names.join(", ");
            inviteeNames.textContent = namesText;
            inviteeSection.classList.remove("hidden");
            guestAttendanceSection.classList.remove("hidden");

            buildGuestAttendanceRows(match.names);

            groupIdInput.value = match.groupId;
            assignedGuestsInput.value = namesText;

            submitButton.disabled = false;

            prefillFromSavedData(match.groupId, match.names);
        }

        // Render selection box when multiple invitations share the same name
        function renderGroupChoices(matches) {
            const box = document.getElementById("multipleMatches");
            const inviteeSection = document.getElementById("inviteeSection");
            const guestAttendanceSection = document.getElementById("guestAttendanceSection");
            const submitButton = document.getElementById("submitButton");

            // reset downstream UI
            inviteeSection.classList.add("hidden");
            guestAttendanceSection.classList.add("hidden");
            submitButton.disabled = true;

            const labelHtml = `
                <div class="invitee-label">We found multiple invitations</div>
                <div class="helper" style="margin-top:4px;margin-bottom:8px;">
                    Please choose the invitation that matches your group.
                </div>
            `;

            const optionsHtml = matches.map((m, i) => {
                const namesText = m.names.join(", ");
                return `
                    <label class="match-option">
                        <input type="radio" name="matchChoice" value="${m.groupId}" ${i === 0 ? "checked" : ""}>
                        <span class="match-option-text">${namesText}</span>
                    </label>
                `;
            }).join("");

            const buttonHtml = `
                <div class="button-row" style="margin-top:10px;">
                    <button type="button" class="btn-secondary" id="confirmMatchButton">Continue</button>
                </div>
            `;

            box.innerHTML = labelHtml + optionsHtml + buttonHtml;
            box.classList.remove("hidden");

            document.getElementById("confirmMatchButton").onclick = () => {
                const selected = document.querySelector('input[name="matchChoice"]:checked');
                if (!selected) return;
                const chosenId = selected.value;
                const match = matches.find(m => m.groupId === chosenId);
                if (match) {
                    selectGroup(match);
                }
            };
        }

        function handleSearch() {
            const searchInput = document.getElementById("searchName");
            const query = searchInput.value;
            const searchError = document.getElementById("searchError");
            const multipleMatchesBox = document.getElementById("multipleMatches");
            const inviteeSection = document.getElementById("inviteeSection");
            const guestAttendanceSection = document.getElementById("guestAttendanceSection");
            const submitButton = document.getElementById("submitButton");
            const errorMessage = document.getElementById("errorMessage");

            searchError.classList.add("hidden");
            errorMessage.classList.add("hidden");
            errorMessage.textContent = "";

            // Rate limiting check
            const now = Date.now();
            if (now - lastSearchTime < SEARCH_COOLDOWN_MS && searchAttempts >= SEARCH_MAX_ATTEMPTS) {
                searchError.textContent = "Too many searches. Please try again in some time.";
                searchError.classList.remove("hidden");
                return;
            }

            // Reset counter if cooldown period has passed
            if (now - lastSearchTime >= SEARCH_COOLDOWN_MS) {
                searchAttempts = 0;
            }

            searchAttempts++;
            lastSearchTime = now;

            // Disable button temporarily if limit is reached
            const searchButton = document.getElementById("searchButton");
            if (searchAttempts >= SEARCH_MAX_ATTEMPTS) {
                searchButton.disabled = true;
                setTimeout(() => {
                    searchButton.disabled = false;
                    searchAttempts = 0;
                }, SEARCH_COOLDOWN_MS);
            }

            // clear multiple-match box on each new search
            multipleMatchesBox.classList.add("hidden");
            multipleMatchesBox.innerHTML = "";

            const matches = findGroupsByName(query);

            if (matches.length === 0) {
                inviteeSection.classList.add("hidden");
                guestAttendanceSection.classList.add("hidden");
                submitButton.disabled = true;
                searchError.textContent =
                    "We couldn‚Äôt find that name. Please check the spelling or contact the host.";
                searchError.classList.remove("hidden");
                return;
            }

            if (matches.length === 1) {
                selectGroup(matches[0]);
            } else {
                renderGroupChoices(matches);
            }
        }

        function enforceRsvpDeadline() {
            const now = new Date();
            const isClosed = now >= RSVP_DEADLINE;

            const closedMsg = document.getElementById("rsvpClosedMessage");
            const searchInput = document.getElementById("searchName");
            const searchButton = document.getElementById("searchButton");
            const form = document.getElementById("rsvpForm");
            const submitButton = document.getElementById("submitButton");

            if (!closedMsg || !form) return;

            if (isClosed) {
                closedMsg.textContent =
                    "RSVP is now closed. Thank you for your love and support ‚Äì we can‚Äôt wait to celebrate with you.";
                closedMsg.classList.remove("hidden");

                if (searchInput) searchInput.disabled = true;
                if (searchButton) searchButton.disabled = true;

                Array.from(form.elements).forEach(el => {
                    el.disabled = true;
                });

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = "RSVP Closed";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            enforceRsvpDeadline();

            const video = document.getElementById("inviteVideo");
            if (video) {
                video.play().catch(() => { });
                const resume = () => {
                    video.play().catch(() => { });
                    document.removeEventListener("click", resume);
                    document.removeEventListener("touchstart", resume);
                };
                document.addEventListener("click", resume);
                document.addEventListener("touchstart", resume);
            }

            const searchButton = document.getElementById("searchButton");
            const searchInput = document.getElementById("searchName");

            searchButton.addEventListener("click", handleSearch);
            searchInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleSearch();
                }
            });

            const form = document.getElementById("rsvpForm");
            const errorMessage = document.getElementById("errorMessage");
            const submitButton = document.getElementById("submitButton");

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                errorMessage.classList.add("hidden");
                errorMessage.textContent = "";

                submitButton.disabled = true;
                submitButton.textContent = "Submitting...";

                const formData = new FormData(form);

                fetch(SCRIPT_URL, {
                    method: "POST",
                    body: formData
                })
                    .then(res => res.json().catch(() => ({})))
                    .then(() => {
                        window.location.href = "thankyou.html";
                    })
                    .catch(err => {
                        console.error(err);
                        errorMessage.textContent =
                            "Something went wrong submitting your RSVP. Please try again or contact the host.";
                        errorMessage.classList.remove("hidden");
                        submitButton.disabled = false;
                        submitButton.textContent = "Submit RSVP";
                    });
            });
        });
    </script>
</body>

</html>